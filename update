#!/bin/bash -e
PATH=$PATH:$(pwd)/dnss-tools/target/appassembler/bin

SOURCE="${BASH_SOURCE[0]}"
while [ -h "$SOURCE" ]; do # resolve $SOURCE until the file is no longer a symlink
  DIR="$( cd -P "$( dirname "$SOURCE" )" && pwd )"
  SOURCE="$(readlink "$SOURCE")"
  [[ $SOURCE != /* ]] && SOURCE="$DIR/$SOURCE" # if $SOURCE was a relative symlink, we need to resolve it relative to the path where the symlink file was located
done
CWD="$( cd -P "$( dirname "$SOURCE" )" && pwd )"

JSON=0
SKILLICONS=0
CONTEXT=0
EXTRACT_PAK=0
EXTRACT_DNT=0
MVN_BUILD=0
FIX_TABLES=0
SKILL_CONTEXT=0
LEVEL_CONTEXT=0
TYPE_CONTEXT=0

function show_help {
    echo This script is used to update SQL, skill icons, etc.
    echo
    echo Usage:
    echo "  ./update [OPTION]..."
    echo
    echo Options:
    echo -e "  --build\t\tDoes a maven build before running any of the other options."
    echo -e "  --extract-pak\t\tRuns the pak extracting program before any of the below options."
    echo -e "  --extract-dnt\t\tRuns the dnt extracting program before any of the below options."
    echo -e "  --json\t\tGenerate the JSON files, and increment the version for the JSON files."
    echo -e "  --skilicons\t\tExtract the skill icons from the DN Pak files."
    echo -e "  --types-context\tGenerate the Spring Bean context file for skill/weapon types."
    echo -e "  --levels-context\tGenerate the Spring Bean context file for the levels and the total sp of each level."
    echo -e "  --skills-context\tGenerate the Spring Bean context file for skills."
    echo -e "  --context\t\tGenerate the primary Spring Bean context file that is loaded when the webapp starts."
    echo -e "  --fix-tables\t\tGenerate the Spring Bean context file."
    echo -e "  -h, --help\t\tDisplays this help message."
}

OPTIND=1
while getopts ":h-:" opt; do
    case "${opt}" in
        -)
            case "${OPTARG}" in
                json) JSON=1 ;;
                skillicons) SKILLICONS=1 ;;
                context) CONTEXT=1 ;;
                extract-pak) EXTRACT_PAK=1 ;;
                extract-dnt) EXTRACT_DNT=1 ;;
                build) MVN_BUILD=1 ;;
                fix-tables) FIX_TABLES=1 ;;
                skills-context) SKILL_CONTEXT=1 ;;
                levels-context) LEVEL_CONTEXT=1 ;;
                types-context) TYPE_CONTEXT=1 ;;
                help) show_help; exit 0 ;;
            esac
            ;;
        h)
            show_help
            exit 0
            ;;
    esac
done
shift $((OPTIND-1))

if [[ ${MVN_BUILD} -eq 1 ]]; then
    mvn clean install -DskipTests --projects dnss-tools --also-make
fi

if [[ ${EXTRACT_PAK} -eq 1 ]]; then
    pak
fi

if [[ ${EXTRACT_DNT} -eq 1 ]]; then
    dnt
    cd  "$(cygpath $(dirname $(grep destination dnss-tools/src/main/resources/dnt.properties | head -1 | cut -d= -f2 | sed 's/ *//')))"
    export PGPASSWORD=dnss
    for sql in *; do
      psql -h localhost -U dnss -d dnss < ${sql}
    done
fi

if [[ ${FIX_TABLES} -eq 1 ]]; then
    ruby ${CWD}/dnss-tools/src/main/ruby/fix_tables.rb
fi

if [[ ${CONTEXT} -eq 1 ]]; then
    ruby ${CWD}/dnss-tools/src/main/ruby/context_generator.rb
fi

if [[ ${SKILL_CONTEXT} -eq 1 ]]; then
    ruby ${CWD}/dnss-tools/src/main/ruby/skills_context_generator.rb
fi

if [[ ${LEVEL_CONTEXT} -eq 1 ]]; then
    ruby ${CWD}/dnss-tools/src/main/ruby/levels_context_generator.rb
fi
if [[ ${TYPE_CONTEXT} -eq 1 ]]; then
    ruby ${CWD}/dnss-tools/src/main/ruby/types_context_generator.rb
fi

if [[ ${JSON} -eq 1 ]]; then
    mkdir -p ${CWD}/dnss-web/src/main/webapp/resources/json/min
    echo Removing ${CWD}/dnss-web/src/main/webapp/resources/json/min
    git rm -f ${CWD}/dnss-web/src/main/webapp/resources/json/min/*

    ruby ${CWD}/dnss-tools/src/main/ruby/json_generator.rb
    version=$(ruby ${CWD}/dnss-tools/src/main/ruby/update_properties.rb json)
    cd ${CWD}/dnss-web/src/main/webapp/resources/json/min
    for file in *; do
        echo Renaming $file to ${version}-${file}
        mv ${file} ${version}-${file}
    done
    git add *
fi

if [[ ${SKILLICONS} -eq 1 ]]; then
    cd ${CWD}/dnss-web/src/main/webapp/resources/images/skillicons
    echo Removing $(ls)
    git rm -f *
    DNPATH=$(cygpath $(grep global.destination dnss-tools/src/main/resources/pak.properties  | head -1 | cut -d= -f2 | sed 's/ *//'))
    cd "${DNPATH}/resource/ui/mainbar"
    echo Formatting $(ls skillicon*.dds) to PNG
    mogrify -format png skillicon*.dds
    echo Cropping $(ls skillicon*.png)
    mogrify -crop 500x550+0+0 +repage +repage skillicon*.png # 550 = 50px * 11 rows
    for png in skillicon*.png; do
        echo pngcrush -ow ${png}
        pngcrush -ow ${png} >/dev/null
    done
    cd -
    echo Copying over $(ls "${DNPATH}/resource/ui/mainbar/"skillicon*.png) to $(pwd)
    cp -f ${DNPATH}/resource/ui/mainbar/skillicon*.png .
    version=$(ruby ${CWD}/dnss-tools/src/main/ruby/update_properties.rb skillicon)
    for file in *; do
        echo Renaming ${file} to ${version}_${file}
        mv ${file} ${version}_${file}
    done
    git add *
fi